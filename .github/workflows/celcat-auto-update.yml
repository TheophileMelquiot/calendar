name: ðŸ“… CELCAT Calendar Auto-Update

on:
  # Scraping complet du semestre tous les 6 mois
  schedule:
    - cron: '0 2 1 1,7 *'  # 1er janvier et 1er juillet Ã  2h du matin
  
  # VÃ©rification quotidienne des changements
  schedule:
    - cron: '0 3 * * *'  # Tous les jours Ã  3h du matin
  
  # PossibilitÃ© de lancer manuellement
  workflow_dispatch:
    inputs:
      mode:
        description: 'Mode de scraping'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - full

jobs:
  # JOB 1: DÃ©cider quel mode utiliser
  determine-mode:
    runs-on: ubuntu-latest
    outputs:
      scrape_mode: ${{ steps.mode.outputs.mode }}
    steps:
      - name: ðŸŽ¯ DÃ©terminer le mode de scraping
        id: mode
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 2 1 1,7 *" ]; then
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            echo "mode=check" >> $GITHUB_OUTPUT
          fi

  # JOB 2: Scraping et gÃ©nÃ©ration du calendrier
  scrape-and-generate:
    needs: determine-mode
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout du repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Installer les dÃ©pendances
        run: |
          pip install selenium beautifulsoup4 ics python-dateutil
      
      - name: ðŸŒ Setup Chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: ðŸš€ Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2
      
      - name: ðŸ” Scraping CELCAT
        env:
          CELCAT_LOGIN_URL: ${{ secrets.CELCAT_LOGIN_URL }}
          CELCAT_USERNAME: ${{ secrets.CELCAT_USERNAME }}
          CELCAT_PASSWORD: ${{ secrets.CELCAT_PASSWORD }}
          SCRAPE_MODE: ${{ needs.determine-mode.outputs.scrape_mode }}
        id: scrape
        run: |
          python scraper_auto.py
      
      - name: ðŸ“„ Conversion JSON â†’ ICS
        run: |
          python json_to_ics.py
      
      - name: ðŸ“Š Statistiques
        run: |
          echo "ðŸ“… Statistiques du calendrier:"
          if [ -f celcat_data.json ]; then
            events_count=$(jq '. | length' celcat_data.json)
            echo "   - Ã‰vÃ©nements totaux: $events_count"
            
            first_date=$(jq -r '.[0].date' celcat_data.json)
            last_date=$(jq -r '.[-1].date' celcat_data.json)
            echo "   - PremiÃ¨re date: $first_date"
            echo "   - DerniÃ¨re date: $last_date"
          fi
      
      - name: ðŸ“¤ Commit et Push si changements
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ajouter les fichiers gÃ©nÃ©rÃ©s
          git add celcat_data.json emploi_du_temps.ics
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "âœ… Aucun changement dÃ©tectÃ©"
          else
            git commit -m "ðŸ”„ Mise Ã  jour automatique du calendrier - $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Calendrier mis Ã  jour et publiÃ©!"
          fi
      
      - name: ðŸ“‹ RÃ©sumÃ©
        if: always()
        run: |
          echo "### ðŸ“… Mise Ã  jour du calendrier CELCAT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode**: ${{ needs.determine-mode.outputs.scrape_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          if [ -f celcat_data.json ]; then
            events_count=$(jq '. | length' celcat_data.json)
            echo "**Ã‰vÃ©nements**: $events_count" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Calendrier disponible Ã : https://[votre-username].github.io/[votre-repo]/emploi_du_temps.ics" >> $GITHUB_STEP_SUMMARY
