name: ğŸ“ Scrape Emploi du Temps Semestriel

# DÃ©clenchement automatique
on:
  schedule:
    # 1er janvier Ã  2h du matin (UTC)
    - cron: '0 2 1 1 *'
    # 1er aoÃ»t Ã  2h du matin (UTC)
    - cron: '0 2 1 8 *'
  
  # DÃ©clenchement manuel (pour tester)
  workflow_dispatch:

jobs:
  scrape-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Installer Python
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. Installer Chrome et ChromeDriver
      - name: ğŸŒ Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      # 4. Installer les dÃ©pendances Python
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # 5. CrÃ©er le fichier de config (reponse.json)
      - name: ğŸ”§ Create config file
        run: |
          echo '{
            "login_url": "${{ secrets.CELCAT_URL }}",
            "username": "${{ secrets.CELCAT_USERNAME }}",
            "password": "${{ secrets.CELCAT_PASSWORD }}"
          }' > reponse.json
      
      # 6. ExÃ©cuter le scraper
      - name: ğŸ•·ï¸ Run scraper (26 weeks)
        run: python src/scraper_complet.py
        timeout-minutes: 60
      
      # 7. Convertir HTML â†’ JSON
      - name: ğŸ“„ Convert HTML to JSON
        run: python src/finaljson.py
      
      # 8. Convertir JSON â†’ ICS
      - name: ğŸ“… Generate ICS file
        run: python src/json_to_ics.py
        
      # 8.5 Rassembler les fichiers HTML & JSON gÃ©nÃ©rÃ©s
      - name: ğŸ“‚ Collect HTML & JSON outputs
        run: |
          mkdir -p debug_outputs
          # Copier les archives HTML (gÃ©nÃ©rÃ©es par le scraper)
          if [ -d "archives_html" ]; then
            cp -r archives_html debug_outputs/
          fi
          # Copier le JSON gÃ©nÃ©rÃ©
          if [ -f "emploi_du_temps_complet.json" ]; then
            cp emploi_du_temps_complet.json debug_outputs/
          fi

      # 9. Obtenir la date pour le nom du fichier
      - name: ğŸ“† Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 10. Upload les fichiers de debug (HTML + JSON) comme artifact
      - name: ğŸ—‚ï¸ Upload debug files (HTML + JSON)
        uses: actions/upload-artifact@v4
        with:
          name: debug-files-${{ steps.date.outputs.date }}
          path: debug_outputs/
          retention-days: 90
      
      # 11. Upload le fichier .ics comme artifact
      - name: ğŸ“¤ Upload ICS file
        uses: actions/upload-artifact@v4
        with:
          name: emploi-du-temps-${{ steps.date.outputs.date }}
          path: emploi_du_temps_complet_v2.ics
          retention-days: 180
      
      # 12. CrÃ©er une release GitHub avec le fichier .ics
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: semester-${{ steps.date.outputs.date }}
          name: Emploi du Temps - ${{ steps.date.outputs.date }}
          body: |
            ğŸ“… Emploi du temps semestriel gÃ©nÃ©rÃ© automatiquement
            
            ğŸ—“ï¸ Date de gÃ©nÃ©ration : ${{ steps.date.outputs.date }}
            ğŸ“Š PÃ©riode couverte : 6 mois (26 semaines)
            
            ### ğŸ“± Installation sur iPhone
            1. TÃ©lÃ©chargez le fichier .ics ci-dessous
            2. Ouvrez-le avec l'app Calendrier
            3. Importez dans votre calendrier prÃ©fÃ©rÃ©
            
            ### ğŸ› Fichiers de debug
            Les fichiers HTML et JSON intermÃ©diaires sont disponibles dans les artifacts de ce workflow pour analyse en cas d'erreur.
          files: emploi_du_temps_complet_v2.ics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
