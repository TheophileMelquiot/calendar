name: ğŸ“ Scrape Emploi du Temps Semestriel

# DÃ©clenchement automatique
on:
  schedule:
    # 1er janvier Ã  2h du matin (UTC)
    - cron: '0 2 1 1 *'
    # 1er aoÃ»t Ã  2h du matin (UTC)
    - cron: '0 2 1 8 *'
  
  # DÃ©clenchement manuel (pour tester)
  workflow_dispatch:
    inputs:
      nb_weeks:
        description: 'Nombre de semaines Ã  scraper (dÃ©faut: 26)'
        required: false
        default: '26'
        type: string
        
jobs:
  scrape-and-generate:
    runs-on: ubuntu-latest
    
    # PERMISSION CRITIQUE : NÃ©cessaire pour pouvoir pusher les modifications sur le repo
    permissions:
      contents: write
    
    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Installer Python
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 3. Installer Chrome et ChromeDriver
      - name: ğŸŒ Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
      
      # 4. Installer les dÃ©pendances Python
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # 5. CrÃ©er le fichier de config (reponse.json)
      - name: ğŸ”§ Create config file
        run: |
          echo '{
            "login_url": "${{ secrets.CELCAT_URL }}",
            "username": "${{ secrets.CELCAT_USERNAME }}",
            "password": "${{ secrets.CELCAT_PASSWORD }}"
          }' > reponse.json
      
      # 6. ExÃ©cuter le scraper
      - name: ğŸ•·ï¸ Run scraper (${{ github.event.inputs.nb_weeks || '26' }} weeks)
        run: python src/scraper_complet.py
        timeout-minutes: 60
        env:
          NB_WEEKS: ${{ github.event.inputs.nb_weeks || '26' }}
      
      # 7. Convertir HTML â†’ JSON
      - name: ğŸ“„ Convert HTML to JSON
        run: python src/html_to_json.py
      
      # 8. Convertir JSON â†’ ICS
      - name: ğŸ“… Generate ICS file
        run: python src/json_to_ics.py
        
      # 8.5 Rassembler les fichiers HTML & JSON gÃ©nÃ©rÃ©s (Debug)
      - name: ğŸ“‚ Collect HTML & JSON outputs
        run: |
          mkdir -p debug_outputs
          if [ -d "archives_html" ]; then
            cp -r archives_html debug_outputs/
          fi
          if [ -f "emploi_du_temps_complet.json" ]; then
            cp emploi_du_temps_complet.json debug_outputs/
          fi

      # 9. Obtenir la date pour le nom du fichier
      - name: ğŸ“† Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 10. Upload les fichiers de debug (HTML + JSON) comme artifact
      - name: ğŸ—‚ï¸ Upload debug files (HTML + JSON)
        uses: actions/upload-artifact@v4
        with:
          name: debug-files-${{ steps.date.outputs.date }}
          path: debug_outputs/
          retention-days: 30
      
      # 11. Upload le fichier .ics comme artifact (Backup)
      - name: ğŸ“¤ Upload ICS file
        uses: actions/upload-artifact@v4
        with:
          name: emploi-du-temps-${{ steps.date.outputs.date }}
          path: mon_emploi_du_temps_fixed.ics
          retention-days: 30
      
      # 12. CrÃ©er une release GitHub avec le fichier .ics
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: semester-${{ steps.date.outputs.date }}
          name: Emploi du Temps - ${{ steps.date.outputs.date }}
          body: |
            ğŸ“… Emploi du temps semestriel gÃ©nÃ©rÃ© automatiquement
            
            ğŸ—“ï¸ Date de gÃ©nÃ©ration : ${{ steps.date.outputs.date }}
            ğŸ“Š PÃ©riode couverte : 6 mois (26 semaines)
            
            ### ğŸ“± Installation sur iPhone
            1. TÃ©lÃ©chargez le fichier .ics ci-dessous
            2. Ouvrez-le avec l'app Calendrier
            3. Importez dans votre calendrier prÃ©fÃ©rÃ©
          files: mon_emploi_du_temps_fixed.ics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

     # 13. Ã‰TAPE CORRIGÃ‰E : Commit et Push avec option -f pour forcer l'ajout
      - name: ğŸ’¾ Commit & Push changes to main
        run: |
          # Configuration de l'identitÃ© Git pour le bot
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # 1. Gestion du dossier JSON
          mkdir -p json
          # Copie le fichier json gÃ©nÃ©rÃ© dans le dossier json/
          cp emploi_du_temps_complet.json json/
          
          # 2. Ajout des fichiers au suivi Git (avec -f pour forcer si ignorÃ©)
          # Ajoute le fichier ICS
          git add -f mon_emploi_du_temps_fixed.ics
          # Ajoute le fichier JSON (force l'ajout mÃªme si ignorÃ© par .gitignore)
          git add -f json/emploi_du_temps_complet.json
          
          # 3. VÃ©rifier s'il y a des changements Ã  commiter
          if git diff --staged --quiet; then
            echo "Aucun changement dÃ©tectÃ© dans l'emploi du temps."
          else
            # Commit et Push si changements
            git commit -m "ğŸ“… Mise Ã  jour auto: Emploi du temps & JSON du ${{ steps.date.outputs.date }}"
            git push origin main
          fi
