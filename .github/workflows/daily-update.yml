name: âš¡ Daily Schedule Check

# DÃ©clenchement : Tous les matins Ã  8h00 Paris (soit 6h00 ou 7h00 UTC selon la saison)
# Ici rÃ©glÃ© sur 7h00 UTC (souvent 8h ou 9h FR, ajuster selon besoin)
on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. RÃ©cupÃ©rer le code
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Setup Chrome (Version lÃ©gÃ¨re pour le daily)
      - name: ðŸŒ Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # 4. DÃ©pendances
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # 5. Config (Secrets)
      - name: ðŸ”§ Create config file
        run: |
          echo '{
            "login_url": "${{ secrets.CELCAT_URL }}",
            "username": "${{ secrets.CELCAT_USERNAME }}",
            "password": "${{ secrets.CELCAT_PASSWORD }}"
          }' > reponse.json

      # 6. ExÃ©cuter le scraper (2 semaines pour le daily check)
      - name: ðŸ•·ï¸ Run scraper (2 weeks)
        run: python src/scraper_complet.py
        timeout-minutes: 60
        env:
          NB_WEEKS: "2"

      # 7. Conversion HTML -> JSON Temporaire
      # Cela doit gÃ©nÃ©rer un fichier temporaire, ex: 'temp_update.json'
      - name: ðŸ“„ Convert HTML to Temp JSON
        run: python src/html_to_json.py --output temp_update.json

      # 7b. ðŸ“¤ Upload du JSON temporaire comme artifact (conservÃ© 7 jours)
      - name: ðŸ“¤ Archive temp JSON artifact
        uses: actions/upload-artifact@v4
        with:
          name: temp-update-json
          path: temp_update.json
          retention-days: 7
          if-no-files-found: warn

      # 8. INTELLIGENCE : Comparaison et Fusion
      # Ce script compare le temp_update.json avec json/emploi_du_temps_complet.json
      # Si changement dÃ©tectÃ© : il met Ã  jour le fichier complet et set une variable d'output.
      - name: ðŸ”„ Compare and Merge JSON
        id: check_changes
        run: python src/merge_and_compare.py
        
      # -----------------------------------------------------------
      # Les Ã©tapes suivantes ne se lancent QUE si des changements sont dÃ©tectÃ©s
      # -----------------------------------------------------------

      # 9. RÃ©gÃ©nÃ©rer le ICS (Uniquement si update)
      - name: ðŸ“… Regenerate ICS file
        if: steps.check_changes.outputs.changed == 'true'
        run: python src/json_to_ics.py

      # 10. Commit & Push (Uniquement si update)
      - name: ðŸ’¾ Commit & Push updates
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # On ajoute le JSON mis Ã  jour par le script de merge
          git add json/emploi_du_temps_complet.json
          git add mon_emploi_du_temps_fixed.ics
          
          git commit -m "âš¡ Mise Ã  jour planning (Changement dÃ©tectÃ©)"
          git push origin main
